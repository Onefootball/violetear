<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Violetear by nbari</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name"><img src="https://raw.githubusercontent.com/nbari/violetear/gh-pages/violetear.png" alt="violetear"></h1>
      <h2 class="project-tagline">Go HTTP router</h2>
      <a href="https://github.com/nbari/violetear" class="btn">View on GitHub</a>
      <a href="https://github.com/nbari/violetear/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/nbari/violetear/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p><a href="https://godoc.org/github.com/nbari/violetear"><img src="https://godoc.org/github.com/nbari/violetear?status.svg" alt="GoDoc"></a>
<a href="https://travis-ci.org/nbari/violetear"><img src="https://travis-ci.org/nbari/violetear.svg?branch=master" alt="Build Status"></a>
<a href="https://coveralls.io/github/nbari/violetear?branch=develop"><img src="https://coveralls.io/repos/nbari/violetear/badge.svg?branch=develop&amp;service=github" alt="Coverage Status"></a>
<a href="https://goreportcard.com/report/github.com/nbari/violetear"><img src="https://goreportcard.com/badge/github.com/nbari/violetear" alt="Go Report Card"></a></p>

<h1>
<a id="violetear" class="anchor" href="#violetear" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>violetear</h1>

<p>Go HTTP router</p>

<h3>
<a id="design-goals" class="anchor" href="#design-goals" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Design Goals</h3>

<ul>
<li>Keep it simple and small, avoiding extra complexity at all cost. <a href="https://en.wikipedia.org/wiki/KISS_principle">KISS</a>
</li>
<li>Support for static and dynamic routing.</li>
<li>Easy middleware compatibility so that it satisfies the http.Handler interface.</li>
<li>Common context between middleware.</li>
<li>Trace Request-ID per request.</li>
</ul>

<p>Package <a href="https://godoc.org/github.com/nbari/violetear">GoDoc</a></p>

<h2>
<a id="how-it-works" class="anchor" href="#how-it-works" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How it works</h2>

<p>The router is capable off handle any kind or URI, static,
dynamic or catchall and based on the
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html">HTTP request Method</a>
accept or discard the request.</p>

<p>For example, suppose we have an API that exposes a service that allow to ping
any IP address.</p>

<p>To handle only "GET" request for any IPv4 addresss:</p>

<pre><code>http://api.violetear.org/command/ping/127.0.0.1
                        \______/\___/\________/
                            |     |      |
                             static      |
                                      dynamic
</code></pre>

<p>The router <code>HandlerFunc</code>  would be:</p>

<pre><code>router.HandleFunc("/command/ping/:ip", ip_handler, "GET")
</code></pre>

<p>For this to work, first the regex matching <code>:ip</code> should be added:</p>

<pre><code>router.AddRegex(":ip", `^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$`)
</code></pre>

<p>Now let's say you also want to be available to ping ipv6 or any host:</p>

<pre><code>http://api.violetear.org/command/ping/*
                        \______/\___/\_/
                            |     |   |
                             static   |
                                   catch-all
</code></pre>

<p>A catch-all could be used and also a different handler, for example:</p>

<pre><code>router.HandleFunc("/command/ping/*", any_handler, "GET, HEAD")
</code></pre>

<p>The <code>*</code> indicates the router to behave like a catch-all therefore it
will match anything after the <code>/command/ping/</code> if no other condition matches
before.</p>

<p>Notice also the "GET, HEAD", that indicates that only does HTTP methods will be
accepted, and any other will not be allowed, router will return a 405 the one
can also be customised.</p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<p><a href="http://gopkg.in/nbari/violetear.v2">http://gopkg.in/nbari/violetear.v2</a></p>

<p>If using <code>go &gt;= 1.7</code> (using context form the standard library):</p>

<pre><code>import "gopkg.in/nbari/violetear.v2"
</code></pre>

<p>If using <code>go &lt; 1.7</code>:</p>

<pre><code>import "gopkg.in/nbari/violetear.v1"
</code></pre>

<p><strong>HandleFunc</strong>:</p>

<pre><code> func HandleFunc(path string, handler http.HandlerFunc, http_methods ...string)
</code></pre>

<p><strong>Handle</strong> (useful for middleware):</p>

<pre><code> func Handle(path string, handler http.Handler, http_methods ...string)
</code></pre>

<p><strong>http_methods</strong> is a comma separted list of allowed HTTP methods, example:</p>

<pre><code>router.HandleFunc("/view", handleView, "GET, HEAD")
</code></pre>

<p><strong>AddRegex</strong> adds a ":named" regular expression to the dynamicRoutes, example:</p>

<pre><code>router.AddRegex(":ip", `^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$`)
</code></pre>

<p>Basic example:</p>

<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s"><span class="pl-pds">"</span>github.com/nbari/violetear<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">catchAll</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-c1">Write</span>([]<span class="pl-k">byte</span>(<span class="pl-s"><span class="pl-pds">"</span>I'm catching all<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>))
}

<span class="pl-k">func</span> <span class="pl-en">handleGET</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-c1">Write</span>([]<span class="pl-k">byte</span>(<span class="pl-s"><span class="pl-pds">"</span>I handle GET requests<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>))
}

<span class="pl-k">func</span> <span class="pl-en">handlePOST</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-c1">Write</span>([]<span class="pl-k">byte</span>(<span class="pl-s"><span class="pl-pds">"</span>I handle POST requests<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>))
}

<span class="pl-k">func</span> <span class="pl-en">handleUUID</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-c1">Write</span>([]<span class="pl-k">byte</span>(<span class="pl-s"><span class="pl-pds">"</span>I handle dynamic requests<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>))
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-smi">router</span> <span class="pl-k">:=</span> violetear.<span class="pl-c1">New</span>()
    router.<span class="pl-smi">LogRequests</span> = <span class="pl-c1">true</span>
    router.<span class="pl-smi">RequestID</span> = <span class="pl-s"><span class="pl-pds">"</span>Request-ID<span class="pl-pds">"</span></span>

    router.<span class="pl-c1">AddRegex</span>(<span class="pl-s"><span class="pl-pds">"</span>:uuid<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">`</span>[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}<span class="pl-pds">`</span></span>)

    router.<span class="pl-c1">HandleFunc</span>(<span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>, catchAll)
    router.<span class="pl-c1">HandleFunc</span>(<span class="pl-s"><span class="pl-pds">"</span>/method<span class="pl-pds">"</span></span>, handleGET, <span class="pl-s"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>)
    router.<span class="pl-c1">HandleFunc</span>(<span class="pl-s"><span class="pl-pds">"</span>/method<span class="pl-pds">"</span></span>, handlePOST, <span class="pl-s"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>)
    router.<span class="pl-c1">HandleFunc</span>(<span class="pl-s"><span class="pl-pds">"</span>/:uuid<span class="pl-pds">"</span></span>, handleUUID, <span class="pl-s"><span class="pl-pds">"</span>GET,HEAD<span class="pl-pds">"</span></span>)

    log.<span class="pl-c1">Fatal</span>(http.<span class="pl-c1">ListenAndServe</span>(<span class="pl-s"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, router))
}</pre></div>

<p>Running this code will show something like this:</p>

<div class="highlight highlight-source-shell"><pre>$ go run <span class="pl-c1">test</span>.go
2015/10/22 17:14:18 Adding path: <span class="pl-k">*</span> [ALL]
2015/10/22 17:14:18 Adding path: /method [GET]
2015/10/22 17:14:18 Adding path: /method [POST]
2015/10/22 17:14:18 Adding path: /:uuid [GET,HEAD]</pre></div>

<p>Using <code>router.Verbose = false</code> will omit printing the paths.</p>

<blockquote>
<p>test.go contains the code show above</p>
</blockquote>

<p>Testing using curl or <a href="https://github.com/jkbrzt/httpie">http</a></p>

<p>Any request 'catch-all':</p>

<div class="highlight highlight-source-shell"><pre>$ http POST http://localhost:8080/
HTTP/1.1 200 OK
Content-Length: 17
Content-Type: text/plain<span class="pl-k">;</span> charset=utf-8
Date: Thu, 22 Oct 2015 15:18:49 GMT
Request-Id: POST-1445527129854964669-1

I<span class="pl-s"><span class="pl-pds">'</span>m catching all</span></pre></div>

<p>A GET request:</p>

<div class="highlight highlight-source-shell"><pre>$ http http://localhost:8080/method
HTTP/1.1 200 OK
Content-Length: 22
Content-Type: text/plain<span class="pl-k">;</span> charset=utf-8
Date: Thu, 22 Oct 2015 15:43:25 GMT
Request-Id: GET-1445528605902591921-1

I handle GET requests</pre></div>

<p>A POST request:</p>

<div class="highlight highlight-source-shell"><pre>$ http POST http://localhost:8080/method
HTTP/1.1 200 OK
Content-Length: 23
Content-Type: text/plain<span class="pl-k">;</span> charset=utf-8
Date: Thu, 22 Oct 2015 15:44:28 GMT
Request-Id: POST-1445528668557478433-2

I handle POST requests</pre></div>

<p>A dynamic request using an <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a> as the URL resource:</p>

<div class="highlight highlight-source-shell"><pre>$ http http://localhost:8080/50244127-45F6-4210-A89D-FFB0DA039425
HTTP/1.1 200 OK
Content-Length: 26
Content-Type: text/plain<span class="pl-k">;</span> charset=utf-8
Date: Thu, 22 Oct 2015 15:45:33 GMT
Request-Id: GET-1445528733916239110-5

I handle dynamic requests</pre></div>

<p>Trying to use POST on the <code>/:uuid</code> resource will cause a
<em>Method not Allowed 405</em> this because only <code>GET</code> and <code>HEAD</code>
methods are allowed:</p>

<div class="highlight highlight-source-shell"><pre>$ http POST http://localhost:8080/50244127-45F6-4210-A89D-FFB0DA039425
HTTP/1.1 405 Method Not Allowed
Content-Length: 19
Content-Type: text/plain<span class="pl-k">;</span> charset=utf-8
Date: Thu, 22 Oct 2015 15:47:19 GMT
Request-Id: POST-1445528839403536403-6
X-Content-Type-Options: nosniff

Method Not Allowed</pre></div>

<h2>
<a id="requestid" class="anchor" href="#requestid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>RequestID</h2>

<p>To keep track of the "requests" an existing "request ID" header can be used, if
the header name for example is <strong>Request-ID</strong> therefore to continue using it,
the router needs to know the name, example:</p>

<pre><code>router := violetear.New()
router.RequestID = "X-Appengine-Request-Log-Id"
</code></pre>

<p>If the proxy is using another name, for example "RID" then use something like:</p>

<pre><code>router := violetear.New()
router.RequestID = "RID"
</code></pre>

<p>If <code>router.RequestID</code> is not set, no "request ID" is going to be added to the
headers. This can be extended using a middleware same has the logger check the
AppEngine example.</p>

<h2>
<a id="notfoundhandler" class="anchor" href="#notfoundhandler" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>NotFoundHandler</h2>

<p>For defining a custom <code>http.Handler</code> to handle <strong>404 Not Found</strong> example:</p>

<pre><code>...

func my404() http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        http.Error(w, "ne ne ne", 404)
    })
}

func main() {
    router := violetear.New()
    router.NotFoundHandler = my404()
    ...
</code></pre>

<h2>
<a id="notallowedhandler" class="anchor" href="#notallowedhandler" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>NotAllowedHandler</h2>

<p>For defining a custom <code>http.Handler</code> to handle <strong>405 Method Not Allowed</strong>.</p>

<h2>
<a id="panichandler" class="anchor" href="#panichandler" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>PanicHandler</h2>

<p>For using a custom http.HandlerFunc to handle panics</p>

<h2>
<a id="middleware" class="anchor" href="#middleware" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Middleware</h2>

<p>Violetear uses <a href="http://justinas.org/alice-painless-middleware-chaining-for-go/">Alice</a> to handle <a href="middleware">middleware</a>.</p>

<p>Example:</p>

<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s"><span class="pl-pds">"</span>context<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>

    <span class="pl-s"><span class="pl-pds">"</span>github.com/nbari/violetear<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>github.com/nbari/violetear/middleware<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">commonHeaders</span>(<span class="pl-v">next</span> <span class="pl-v">http</span>.<span class="pl-v">Handler</span>) <span class="pl-v">http</span>.<span class="pl-v">Handler</span> {
    <span class="pl-k">return</span> http.<span class="pl-c1">HandlerFunc</span>(<span class="pl-k">func</span>(w http.<span class="pl-smi">ResponseWriter</span>, r *http.<span class="pl-smi">Request</span>) {
        w.<span class="pl-c1">Header</span>().<span class="pl-c1">Set</span>(<span class="pl-s"><span class="pl-pds">"</span>X-app-Version<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>1.0<span class="pl-pds">"</span></span>)
        next.<span class="pl-c1">ServeHTTP</span>(w, r)
    })
}

<span class="pl-k">func</span> <span class="pl-en">middlewareOne</span>(<span class="pl-v">next</span> <span class="pl-v">http</span>.<span class="pl-v">Handler</span>) <span class="pl-v">http</span>.<span class="pl-v">Handler</span> {
    <span class="pl-k">return</span> http.<span class="pl-c1">HandlerFunc</span>(<span class="pl-k">func</span>(w http.<span class="pl-smi">ResponseWriter</span>, r *http.<span class="pl-smi">Request</span>) {
        log.<span class="pl-c1">Println</span>(<span class="pl-s"><span class="pl-pds">"</span>Executing middlewareOne<span class="pl-pds">"</span></span>)
        <span class="pl-smi">ctx</span> <span class="pl-k">:=</span> context.<span class="pl-c1">WithValue</span>(r.<span class="pl-c1">Context</span>(), <span class="pl-s"><span class="pl-pds">"</span>m1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>m1<span class="pl-pds">"</span></span>)
        ctx = context.<span class="pl-c1">WithValue</span>(ctx, <span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span>, <span class="pl-c1">1</span>)
        next.<span class="pl-c1">ServeHTTP</span>(w, r.<span class="pl-c1">WithContext</span>(ctx))
        log.<span class="pl-c1">Println</span>(<span class="pl-s"><span class="pl-pds">"</span>Executing middlewareOne again<span class="pl-pds">"</span></span>)
    })
}

<span class="pl-k">func</span> <span class="pl-en">middlewareTwo</span>(<span class="pl-v">next</span> <span class="pl-v">http</span>.<span class="pl-v">Handler</span>) <span class="pl-v">http</span>.<span class="pl-v">Handler</span> {
    <span class="pl-k">return</span> http.<span class="pl-c1">HandlerFunc</span>(<span class="pl-k">func</span>(w http.<span class="pl-smi">ResponseWriter</span>, r *http.<span class="pl-smi">Request</span>) {
        log.<span class="pl-c1">Println</span>(<span class="pl-s"><span class="pl-pds">"</span>Executing middlewareTwo<span class="pl-pds">"</span></span>)
        <span class="pl-k">if</span> r.<span class="pl-smi">URL</span>.<span class="pl-smi">Path</span> != <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span> {
            <span class="pl-k">return</span>
        }
        <span class="pl-smi">ctx</span> <span class="pl-k">:=</span> context.<span class="pl-c1">WithValue</span>(r.<span class="pl-c1">Context</span>(), <span class="pl-s"><span class="pl-pds">"</span>m2<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>m2<span class="pl-pds">"</span></span>)
        next.<span class="pl-c1">ServeHTTP</span>(w, r.<span class="pl-c1">WithContext</span>(ctx))
        log.<span class="pl-c1">Println</span>(<span class="pl-s"><span class="pl-pds">"</span>Executing middlewareTwo again<span class="pl-pds">"</span></span>)
    })
}

<span class="pl-k">func</span> <span class="pl-en">catchAll</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    log.<span class="pl-c1">Printf</span>(<span class="pl-s"><span class="pl-pds">"</span>Executing finalHandler<span class="pl-cce">\n</span>m1:<span class="pl-c1">%s</span><span class="pl-cce">\n</span>key:<span class="pl-c1">%d</span><span class="pl-cce">\n</span>m2:<span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
        r.<span class="pl-c1">Context</span>().<span class="pl-c1">Value</span>(<span class="pl-s"><span class="pl-pds">"</span>m1<span class="pl-pds">"</span></span>),
        r.<span class="pl-c1">Context</span>().<span class="pl-c1">Value</span>(<span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span>),
        r.<span class="pl-c1">Context</span>().<span class="pl-c1">Value</span>(<span class="pl-s"><span class="pl-pds">"</span>m2<span class="pl-pds">"</span></span>),
    )
    w.<span class="pl-c1">Write</span>([]<span class="pl-k">byte</span>(<span class="pl-s"><span class="pl-pds">"</span>I catch all<span class="pl-pds">"</span></span>))
}

<span class="pl-k">func</span> <span class="pl-en">foo</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    <span class="pl-c1">panic</span>(<span class="pl-s"><span class="pl-pds">"</span>this will never happen, because of the return<span class="pl-pds">"</span></span>)
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-smi">router</span> <span class="pl-k">:=</span> violetear.<span class="pl-c1">New</span>()

    <span class="pl-smi">stdChain</span> <span class="pl-k">:=</span> middleware.<span class="pl-c1">New</span>(commonHeaders, middlewareOne, middlewareTwo)

    router.<span class="pl-c1">Handle</span>(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, stdChain.<span class="pl-c1">ThenFunc</span>(catchAll), <span class="pl-s"><span class="pl-pds">"</span>GET,HEAD<span class="pl-pds">"</span></span>)
    router.<span class="pl-c1">Handle</span>(<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span>, stdChain.<span class="pl-c1">ThenFunc</span>(foo), <span class="pl-s"><span class="pl-pds">"</span>GET,HEAD<span class="pl-pds">"</span></span>)
    router.<span class="pl-c1">HandleFunc</span>(<span class="pl-s"><span class="pl-pds">"</span>/bar<span class="pl-pds">"</span></span>, foo)

    log.<span class="pl-c1">Fatal</span>(http.<span class="pl-c1">ListenAndServe</span>(<span class="pl-s"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, router))
}</pre></div>

<blockquote>
<p>Notice the use or router.Handle and router.HandleFunc when using middleware
you normally would use route.Handle</p>
</blockquote>

<p>Request output example:</p>

<div class="highlight highlight-source-shell"><pre>$ http http://localhost:8080/
HTTP/1.1 200 OK
Content-Length: 11
Content-Type: text/plain<span class="pl-k">;</span> charset=utf-8
Date: Thu, 22 Oct 2015 16:08:18 GMT
Request-Id: GET-1445530098002701428-3
X-App-Version: 1.0

I catch all</pre></div>

<p>On the server you will see something like this:</p>

<div class="highlight highlight-source-shell"><pre>$ go run <span class="pl-c1">test</span>.go
2016/08/17 18:08:42 Adding path: / [GET,HEAD]
2016/08/17 18:08:42 Adding path: /foo [GET,HEAD]
2016/08/17 18:08:42 Adding path: /bar [ALL]
2016/08/17 18:08:47 Executing middlewareOne
2016/08/17 18:08:47 Executing middlewareTwo
2016/08/17 18:08:47 Executing finalHandler
m1:m1
key:1
m2:m2
2016/08/17 18:08:47 Executing middlewareTwo again
2016/08/17 18:08:47 Executing middlewareOne again</pre></div>

<h2>
<a id="appengine" class="anchor" href="#appengine" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>AppEngine</h2>

<p>The app.yaml file:</p>

<div class="highlight highlight-source-yaml"><pre><span class="pl-ent">application:</span> <span class="pl-s"><span class="pl-pds">'</span>app-name<span class="pl-pds">'</span></span>
<span class="pl-ent">version:</span> <span class="pl-c1">1</span>
<span class="pl-ent">runtime:</span> <span class="pl-s">go</span>
<span class="pl-ent">api_version:</span> <span class="pl-s">go1</span>

<span class="pl-ent">handlers:</span>

- <span class="pl-ent">url:</span> <span class="pl-s">/.*</span>
  <span class="pl-ent">script:</span> <span class="pl-s">_go_app</span></pre></div>

<p>The app.go file:</p>

<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> app

<span class="pl-k">import</span> (
    <span class="pl-s"><span class="pl-pds">"</span>appengine<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>github.com/nbari/violetear<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>github.com/nbari/violetear/middleware<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">init</span>() {
    <span class="pl-smi">router</span> <span class="pl-k">:=</span> violetear.<span class="pl-c1">New</span>()
    <span class="pl-smi">stdChain</span> <span class="pl-k">:=</span> middleware.<span class="pl-c1">New</span>(requestID)
    router.<span class="pl-c1">Handle</span>(<span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>, stdChain.<span class="pl-c1">ThenFunc</span>(index), <span class="pl-s"><span class="pl-pds">"</span>GET, HEAD<span class="pl-pds">"</span></span>)
    http.<span class="pl-c1">Handle</span>(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, router)
}

<span class="pl-k">func</span> <span class="pl-en">requestID</span>(<span class="pl-v">next</span> <span class="pl-v">http</span>.<span class="pl-v">Handler</span>) <span class="pl-v">http</span>.<span class="pl-v">Handler</span> {
    <span class="pl-k">return</span> http.<span class="pl-c1">HandlerFunc</span>(<span class="pl-k">func</span>(w http.<span class="pl-smi">ResponseWriter</span>, r *http.<span class="pl-smi">Request</span>) {
        <span class="pl-smi">c</span> <span class="pl-k">:=</span> appengine.<span class="pl-c1">NewContext</span>(r)
        w.<span class="pl-c1">Header</span>().<span class="pl-c1">Set</span>(<span class="pl-s"><span class="pl-pds">"</span>Request-ID<span class="pl-pds">"</span></span>, appengine.<span class="pl-c1">RequestID</span>(c))
        next.<span class="pl-c1">ServeHTTP</span>(w, r)
    })
}

<span class="pl-k">func</span> <span class="pl-en">index</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-c1">Write</span>([]<span class="pl-k">byte</span>(<span class="pl-s"><span class="pl-pds">"</span>Hello world!<span class="pl-pds">"</span></span>))
}</pre></div>

<p>Demo: <a href="http://api.violetear.org">http://api.violetear.org</a></p>

<p>Using <code>curl</code> or <code>http</code>:</p>

<div class="highlight highlight-source-shell"><pre>$ http http://api.violetear.org
HTTP/1.1 200 OK
Cache-Control: private
Content-Encoding: gzip
Content-Length: 32
Content-Type: text/html<span class="pl-k">;</span> charset=utf-8
Date: Sun, 25 Oct 2015 06:14:55 GMT
Request-Id: 562c735f00ff0902f823e514a90001657e76696f6c65746561722d31313037000131000100
Server: Google Frontend

Hello world<span class="pl-k">!</span></pre></div>

<h1>
<a id="context--named-parameters" class="anchor" href="#context--named-parameters" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Context &amp; Named parameters</h1>

<p>In some cases there is a need to pass data across
handlers/middlewares, for doing this <strong>Violetear</strong> uses
<a href="https://godoc.org/golang.org/x/net/context">net/context</a>.</p>

<p>Example:</p>

<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s"><span class="pl-pds">"</span>context<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>fmt<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>

    <span class="pl-s"><span class="pl-pds">"</span>github.com/nbari/violetear<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">catchAll</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    <span class="pl-c">// Get &amp; print the content of named-param *</span>
    <span class="pl-smi">params</span> <span class="pl-k">:=</span> r.<span class="pl-c1">Context</span>().<span class="pl-c1">Value</span>(violetear.<span class="pl-smi">ParamsKey</span>).(violetear.<span class="pl-smi">Params</span>)
    fmt.<span class="pl-c1">Fprintf</span>(w, <span class="pl-s"><span class="pl-pds">"</span>CatchAll value:, <span class="pl-c1">%q</span><span class="pl-pds">"</span></span>, params[<span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>])
}

<span class="pl-k">func</span> <span class="pl-en">handleUUID</span>(<span class="pl-v">w</span> <span class="pl-v">http</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">http</span>.<span class="pl-v">Request</span>) {
    <span class="pl-c">// get router params</span>
    <span class="pl-smi">params</span> <span class="pl-k">:=</span> r.<span class="pl-c1">Context</span>().<span class="pl-c1">Value</span>(violetear.<span class="pl-smi">ParamsKey</span>).(violetear.<span class="pl-smi">Params</span>)
    <span class="pl-c">// add a key-value pair to the context</span>
    <span class="pl-smi">ctx</span> <span class="pl-k">:=</span> context.<span class="pl-c1">WithValue</span>(r.<span class="pl-c1">Context</span>(), <span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>my-value<span class="pl-pds">"</span></span>)
    <span class="pl-c">// print current value for :uuid</span>
    fmt.<span class="pl-c1">Fprintf</span>(w, <span class="pl-s"><span class="pl-pds">"</span>Named parameter: <span class="pl-c1">%q</span>, key: <span class="pl-c1">%s</span><span class="pl-pds">"</span></span>,
        params[<span class="pl-s"><span class="pl-pds">"</span>:uuid<span class="pl-pds">"</span></span>],
        ctx.<span class="pl-c1">Value</span>(<span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span>),
    )
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-smi">router</span> <span class="pl-k">:=</span> violetear.<span class="pl-c1">New</span>()

    router.<span class="pl-c1">AddRegex</span>(<span class="pl-s"><span class="pl-pds">"</span>:uuid<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">`</span>[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}<span class="pl-pds">`</span></span>)

    router.<span class="pl-c1">HandleFunc</span>(<span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>, catchAll)
    router.<span class="pl-c1">HandleFunc</span>(<span class="pl-s"><span class="pl-pds">"</span>/:uuid<span class="pl-pds">"</span></span>, handleUUID, <span class="pl-s"><span class="pl-pds">"</span>GET,HEAD<span class="pl-pds">"</span></span>)

    log.<span class="pl-c1">Fatal</span>(http.<span class="pl-c1">ListenAndServe</span>(<span class="pl-s"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, router))
}</pre></div>

<h2>
<a id="duplicated-named-parameters" class="anchor" href="#duplicated-named-parameters" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Duplicated named parameters</h2>

<p>In cases where the same named parameter is used multiple times, example:</p>

<pre><code>/test/:uuid/:uuid/
</code></pre>

<p>An slice is created, for getting the values you need to do something like:</p>

<pre><code>    params := r.Context().Value(violetear.ParamsKey).(violetear.Params)
    uuid := params[":uuid"].([]string)
</code></pre>

<blockquote>
<p>Notice the <code>:</code> prefix when getting the named_parameters</p>
</blockquote>

<p>After this you can access the slice like normal:</p>

<pre><code>    fmt.Println(uuid[0], uuid[1])
</code></pre>

<h2>
<a id="only-for-go--17" class="anchor" href="#only-for-go--17" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Only for go &lt; 1.7</h2>

<p>For been available to use the <strong>Context</strong> <code>ctx</code> you need to do a type assertion:</p>

<pre><code>cw := w.(*violetear.ResponseWriter)
</code></pre>

<p>To set a key-value pair you need to:</p>

<pre><code>cw.Set(key, value)
</code></pre>

<p>or</p>

<pre><code>cw.ctx = context.WithValue(cw.ctx, "key", "my-value")
</code></pre>

<p>To retrieve a value:</p>

<pre><code>cw.Get(value)
</code></pre>

<p>or</p>

<pre><code>cw.ctx.Value("key")
</code></pre>

<blockquote>
<p>You may need <a href="https://golang.org/ref/spec#Type_assertions">Type assertions</a>: <code>cw.Get(value).(string)</code> depending on your needs.</p>
</blockquote>

<p>More references:</p>

<ul>
<li><a href="https://tip.golang.org/doc/go1.7#context">https://tip.golang.org/doc/go1.7#context</a></li>
<li><a href="https://justinas.org/alice-painless-middleware-chaining-for-go/">https://justinas.org/alice-painless-middleware-chaining-for-go/</a></li>
<li><a href="http://www.alexedwards.net/blog/making-and-using-middleware">http://www.alexedwards.net/blog/making-and-using-middleware</a></li>
<li><a href="https://golang.org/ref/spec#Type_assertions">https://golang.org/ref/spec#Type_assertions</a></li>
</ul>

<h2>
<a id="canonicalized-headers-issues" class="anchor" href="#canonicalized-headers-issues" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Canonicalized headers issues</h2>

<p>Go version &lt; 1.5 will canonicalize the header (from uppercase to lowercase),
example:</p>

<p><a href="https://travis-ci.org/nbari/violetear/jobs/81059152#L156">https://travis-ci.org/nbari/violetear/jobs/81059152#L156</a> golang 1.4</p>

<p><a href="https://travis-ci.org/nbari/violetear/jobs/81059153#L156">https://travis-ci.org/nbari/violetear/jobs/81059153#L156</a> golang 1.5</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/nbari/violetear">Violetear</a> is maintained by <a href="https://github.com/nbari">nbari</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-69163599-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
